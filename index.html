<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>義消服務查詢（分段＋內聯規則＋法規模態框）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5 & jQuery（CDN） -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body { background:#f7f8fa; }
    .page-title { font-weight:700; letter-spacing:.05em; }
    .card-soft { border:1px solid #e9ecef; }
    .section-title { font-weight:700; margin-bottom:.25rem; }
    .keyline { border-left:4px solid #0d6efd; padding-left:.75rem; }
    .kv { display:flex; gap:.5rem; align-items:baseline; margin:.35rem 0; }
    .label { width:12em; color:#6c757d; }
    .ok { color:#0a8754; font-weight:700; }
    .warn { color:#c92a2a; font-weight:800; }
    .rule { color:#6c757d; font-size:.9rem; }
    .mono { font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    .w-18 { width:18rem; }
  </style>
</head>
<body>
<div class="container py-4">
  <!-- Header -->
  <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
    <h1 class="page-title h4 m-0">義消服務查詢</h1>
    <div class="d-flex align-items-center gap-2">
      <span class="text-secondary">查詢年月：</span>
      <select id="selYear" class="form-select form-select-sm w-18"></select>
      <select id="selMonth" class="form-select form-select-sm w-18"></select>
      <span id="rocBadge" class="badge text-bg-light"></span>

      <!-- 規則與法規條文 按鈕 -->
      <button class="btn btn-outline-secondary btn-sm ms-2" data-bs-toggle="modal" data-bs-target="#rulesModal">
        規則與法規條文
      </button>
    </div>
  </div>

  <!-- 查詢列 -->
  <div class="card card-soft mb-4">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label">姓名</label>
          <input id="txtName" type="text" class="form-control" placeholder="輸入姓名（支援部分比對）">
        </div>
        <div class="col-md-3">
          <button id="btnSearch" class="btn btn-primary w-100">查詢</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 個人資料（新增：只顯示 單位／職稱／姓名） -->
  <div class="card card-soft mb-4 d-none" id="cardPerson">
    <div class="card-body">
      <div class="section-title keyline">個人資料</div>
      <div class="kv"><div class="label">單位：</div><div id="p_unit">—</div></div>
      <div class="kv"><div class="label">職稱：</div><div id="p_title">—</div></div>
      <div class="kv"><div class="label">姓名：</div><div id="p_name">—</div></div>
    </div>
  </div>

  <!-- 查詢結果：協勤/訓練/年資/累積 -->
  <div class="card card-soft mb-4 d-none" id="cardSummary">
    <div class="card-body">
      <div class="section-title keyline">查詢結果</div>

      <div class="kv">
        <div class="label">協勤時數：</div>
        <div>
          <span id="dutyHoursTotal">0</span> 小時； <span id="dutyStatus" class="ok">正常</span>
          <span id="ruleDuty" class="rule ms-2"></span>
        </div>
      </div>

      <div class="kv">
        <div class="label">常年訓練：</div>
        <div>
          <span id="trainingYear">—</span> 年 出席 <span id="trainingAttend">0</span> 次、請假 <span id="trainingLeave">0</span> 次、缺席 <span id="trainingAbsent">0</span> 次；
          <span id="trainingStatus" class="ok">正常</span>
          <span id="ruleTraining" class="rule ms-2"></span>
        </div>
      </div>

      <div class="kv"><div class="label">服務年資：</div><div><span id="serviceYears">0</span> 年</div></div>
      <div class="kv"><div class="label">入隊累積時數：</div><div><span id="joinAccHours">0</span> 小時</div></div>
    </div>
  </div>

  <!-- 班程 -->
  <div class="card card-soft mb-4 d-none" id="cardCourses">
    <div class="card-body">
      <div class="section-title keyline">班程</div>

      <div class="kv">
        <div class="label">新進人員基本訓練：</div>
        <div>
          <span id="courseBasicState" class="ok">—</span>
          <span id="ruleCourseBasic" class="rule ms-2"></span>
        </div>
      </div>

      <div class="kv">
        <div class="label">基礎幹部講習班：</div>
        <div>
          <span id="courseCadreState" class="ok">—</span>
          <span id="ruleCourseCadre" class="rule ms-2"></span>
        </div>
      </div>

      <!-- ★ 新增：初級幹部講習班（第三列） -->
      <div class="kv">
        <div class="label">初級幹部講習班：</div>
        <div>
          <span id="courseJuniorState" class="ok">—</span>
          <span id="ruleCourseJunior" class="rule ms-2"></span>
        </div>
      </div>
      <!-- ★ 結束新增 -->
    </div>
  </div>

  <!-- 獎項 -->
  <div class="card card-soft mb-4 d-none" id="cardAwards">
    <div class="card-body">
      <div class="section-title keyline">獎項</div>

      <div class="kv">
        <div class="label">全國義消楷模（鳳凰獎）：</div>
        <div>
          <span id="awardPhoenix" class="ok">—</span>
          <span id="ruleAwardPhoenix" class="rule ms-2"></span>
        </div>
      </div>

      <div class="kv">
        <div class="label">全國救護志工菁英：</div>
        <div>
          <span id="awardEMS" class="ok">—</span>
          <span id="ruleAwardEMS" class="rule ms-2"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- 每月協勤 -->
  <div class="card card-soft mb-5 d-none" id="cardMonthly">
    <div class="card-body">
      <div class="section-title keyline">每月協勤時數</div>
      <div class="kv"><div class="label">查詢年月：</div><div id="ymRoc">000年 00月</div></div>
      <div class="kv"><div class="label">本月協勤時數：</div><div><span id="monthHours">0</span> 小時</div></div>
      <pre id="recentN" class="mono bg-light p-3 border rounded small mb-0"></pre>
    </div>
  </div>

  <!-- 空結果 -->
  <div id="emptyHint" class="alert alert-info d-none">查無此人，請重新輸入（支援部分字）。</div>
</div>

<!-- 規則與法規條文 Modal -->
<div class="modal fade" id="rulesModal" tabindex="-1" aria-labelledby="rulesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="rulesModalLabel" class="modal-title">規則與法規條文</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
      </div>
      <div class="modal-body">
        <div id="rulesDoc"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   參數規則（只在 Script 可調）
   ========================= */
const RULES = {
  duty: { minMonthlyHours: 4, rolling: { months: 6, minSum: 24 } },
  training: { minAttendPerYear: 12 },
  awards: {
    phoenix: { minServiceYears: 5, minTotalHours: 800, cooldownPhoenixYears: 5, cooldownEMSYears: 2 },
    emsElite: { minServiceYears: 5 }
  },
  courses: {
    basic:  { mustFinishWithinYears: 2 },
    cadre:  { eligibleAfterYears: 1, mustFinishWithinYears: 3 },
    junior: { note: '依單位規範，如有年限請自訂' }
  },
  serviceYears: { calcMode: 'auto' },
  display: { recentMonths: 6, rocYear: true }
};

/* =========================
   法規條文（唯讀展示）
   ========================= */
const LEGAL = {
  titles: {
    duty: "義勇消防組織編組訓練演習服勤辦法 第 15 條（示例）",
    training: "義勇消防組織編組訓練演習服勤辦法 第 12 條（示例）",
    courses: {
      basic:  "義勇消防組織編組訓練演習服勤辦法 第 7 條（示例）",
      cadre:  "義勇消防組織編組訓練演習服勤辦法 第 8 條（示例）",
      junior: "（單位內規）"
    },
    awards: {
      phoenix: "全國義消楷模評選要點 第 3 點（示例）",
      ems: "救護志工菁英評選要點 第 2 點（示例）"
    }
  },
  excerpts: {
    duty: "每月協勤應達一定時數，或以連續數月累計達標。",
    training: "常年訓練每年應參與達一定次數。",
    basic: "新進人員應於到隊後一定年限內完成基本訓練。",
    cadre: "幹部講習應於符合年資門檻後一定年限內完成。",
    junior: "初級幹部講習班之時程與門檻依單位內規訂定。",
    phoenix: "評選須符合年資與服務時數，並符合最近年度之冷卻條件。",
    ems: "評選須符合年資等基本條件。"
  }
};

/* =========================
   資料來源設定（換成你的 /exec）
   ========================= */
const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzdSOlPTYxXhWbIls1EUJ7NhjIY-MW4H6WcKcf3BfD4WagbKxe42lQxltqmw6XIPPJp/exec'; // ← 改成你的

/* 全域狀態 */
let CURRENT_PERSON = null;   // 〈人員資料〉單筆物件（或 false 表示查無）
let CURRENT_HOURS  = null;   // { name, months:{'114-06':4,...}, total }
let __PENDING__ = 0;         // 載入中計數（for spinner）

/* =========================
   小工具
   ========================= */
const pad2 = n => (n<10?`0${n}`:`${n}`);
const toRoc = y => y - 1911;
const ym = (y,m)=>`${y}-${pad2(m)}`;
const fmtYm = (y,m)=> RULES.display.rocYear ? `${toRoc(y)}年 ${pad2(m)}月` : `${y}年 ${pad2(m)}月`;
function recentKeys(y,m,n){ const a=[]; let yy=y,mm=m; for(let i=0;i<n;i++){ a.unshift(ym(yy,mm)); mm--; if(mm===0){ mm=12; yy--; } } return a; }

function jsonp(url, cb){
  const cbName = 'cb_' + Date.now() + '_' + Math.floor(Math.random()*1e6);
  window[cbName] = (resp)=>{ try{ cb(resp); } finally{ delete window[cbName]; } };
  const s = document.createElement('script');
  s.src = url + (url.includes('?')?'&':'?') + 'callback=' + cbName;
  s.onerror = ()=> cb({ ok:false, error:'讀取失敗（可能是 URL 或權限）' });
  document.body.appendChild(s);
}
function getField(o, keys){ for(const k of keys){ if(o && o[k]!=null && String(o[k]).trim()!=='') return String(o[k]).trim(); } return ''; }
function getNum(o, keys){ const s=getField(o,keys); const n=Number(String(s).replace(/[, ]/g,'')); return isFinite(n)?n:0; }

/* 解析「素行調查時間/素行梯次」→ Date（支援民國/西元、年或年月） */
function parseConductDate(str){
  if(!str) return null;
  let s = String(str).trim();
  // e.g. 2000/02、2003-02、114/09、114-9、2020
  const m = s.match(/^(\d{2,4})[\/\-.年]?\s*(\d{1,2})?(?:[\/\-.日]?\s*(\d{1,2}))?$/);
  if(!m) return null;
  let y = parseInt(m[1],10);
  let mo = parseInt(m[2]||'1',10);
  let d  = parseInt(m[3]||'1',10);
  // 小於1911 視為民國年
  if(y < 1911) y += 1911;
  return new Date(y, Math.max(0,mo-1), Math.max(1,d));
}

/* ROC/西元 換算（先宣告，供判定使用） */
const toRocYM = (y,m)=> `${String(toRoc(y)).padStart(3,'0')}-${pad2(m)}`;
function gyToRocYm(gy){ const [y,m]=gy.split('-').map(Number); return toRocYM(y,m); }

/* 服務年資（以「素行調查」欄位為準；找不到再退回入隊日期/年資欄） */
function calcServiceYearsFromConduct(p){
  const sConduct = getField(p, ['素行調查時間','素行調查','素行梯次','素行','素行日期']);
  let base = parseConductDate(sConduct);
  if(!base){
    // 退回入隊日期或年資欄
    const sJoin = getField(p, ['入隊日期','到隊日期','入隊日','到隊日','入隊']);
    if(sJoin) base = parseConductDate(sJoin);
  }
  if(base){
    const now = new Date();
    let y = now.getFullYear() - base.getFullYear();
    const m = now.getMonth() - base.getMonth();
    if(m < 0 || (m===0 && now.getDate() < base.getDate())) y--;
    return Math.max(0, y);
  }
  return getNum(p, ['服務年資','年資']) || 0;
}

/* 協勤判定（用 ROC 月欄） */
function judgeDuty(y,m,hr){
  const ymRoc = toRocYM(y,m);
  const mon = Number((hr.months||{})[ymRoc]||0);
  const keysGy = recentKeys(y,m,RULES.display.recentMonths).map(k=>gyToRocYm(k));
  const sum = keysGy.reduce((s,k)=>s+(Number((hr.months||{})[k]||0)),0);
  const ok = (mon>=RULES.duty.minMonthlyHours) || (sum>=RULES.duty.rolling.minSum);
  return { mon, sum, keysGy, ok };
}

/* 班程欄位判斷 */
function asBoolDone(v){
  const s = String(v||'').trim();
  if(!s) return false;
  if(/已完成|完成|是|Y|yes|已結訓/i.test(s)) return true;
  if(/^(\d{3,4})[\/\-.年]\s*\d{1,2}$/.test(s) || /^(\d{3,4})$/.test(s)) return true;
  return false;
}
function courseLabelRaw(v){
  const s = String(v||'').trim();
  if(!s) return '未完成';
  if(/^(\d{3,4})([\/\-.年]\s*\d{1,2})?$/.test(s)) return `已完成（${s}）`;
  if(/已完成|完成|是|Y|yes|已結訓/i.test(s)) return '已完成';
  return s;
}

/* =========================
   年月 UI
   ========================= */
function initYM(){
  const t = new Date();
  const y = t.getFullYear();
  const m = t.getMonth() + 1;

  const years = [y-2, y-1, y, y+1];
  $('#selYear').empty();
  $('#selMonth').empty();

  years.forEach(yy => {
    $('#selYear').append(
      `<option value="${yy}">${yy}${RULES.display.rocYear ? `（民國${toRoc(yy)}年）` : ''}</option>`
    );
  });

  // 這行原本多了一個「)」，導致整個 script 掛掉
  for (let i = 1; i <= 12; i++) {
    $('#selMonth').append(`<option value="${i}">${pad2(i)}月</option>`);
  }

  $('#selYear').val(y);
  $('#selMonth').val(m);
  $('#rocBadge').text(RULES.display.rocYear ? `民國 ${toRoc(y)} 年` : `${y} 年`);
}

/* =========================
   規則 Modal（動態渲染）
   ========================= */
function buildRulesDoc(){
  const P = RULES.awards.phoenix;
  const html = `
    <div class="mb-3">
      <h6>協勤 <small class="text-secondary">（${LEGAL.titles.duty}）</small></h6>
      <div class="text-secondary">
        每月 ≥ <b>${RULES.duty.minMonthlyHours}</b> 小時，或最近 <b>${RULES.display.recentMonths}</b> 月合計 ≥ <b>${RULES.duty.rolling.minSum}</b> 小時。
        <br>${LEGAL.excerpts.duty || ""}
      </div>
    </div>
    <div class="mb-3">
      <h6>常年訓練 <small class="text-secondary">（${LEGAL.titles.training}）</small></h6>
      <div class="text-secondary">
        全年訓練應達 <b>${RULES.training.minAttendPerYear}</b> 次。
        <br>${LEGAL.excerpts.training || ""}
      </div>
    </div>
    <div class="mb-3">
      <h6>班程 <small class="text-secondary">（基本：${LEGAL.titles.courses.basic}；基礎幹部：${LEGAL.titles.courses.cadre}；初級幹部：${LEGAL.titles.courses.junior}）</small></h6>
      <div class="text-secondary">
        基本訓練 <b>${RULES.courses.basic.mustFinishWithinYears}</b> 年內完成；
        幹部講習滿 <b>${RULES.cadre?.eligibleAfterYears || RULES.courses.cadre.eligibleAfterYears}</b> 年後、<b>${RULES.courses.cadre.mustFinishWithinYears}</b> 年內完成；
        初級幹部：<b>${RULES.courses.junior.note}</b>。
        <br>${LEGAL.excerpts.basic || ""}｜${LEGAL.excerpts.cadre || ""}｜${LEGAL.excerpts.junior || ""}
      </div>
    </div>
    <div class="mb-3">
      <h6>獎項 <small class="text-secondary">（鳳凰獎：${LEGAL.titles.awards.phoenix}；救護志工菁英：${LEGAL.titles.awards.ems}）</small></h6>
      <div class="text-secondary">
        鳳凰獎：年資 ≥ <b>${P.minServiceYears}</b>、時數 ≥ <b>${P.minTotalHours}</b>；
        救護志工菁英：年資 ≥ <b>${RULES.awards.emsElite.minServiceYears}</b> 年。
        <br>${LEGAL.excerpts.phoenix || ""} ${LEGAL.excerpts.ems ? "｜"+LEGAL.excerpts.ems : ""}
      </div>
    </div>`;
  $('#rulesDoc').html(html);
}
$('#rulesModal').on('show.bs.modal', buildRulesDoc);

/* =========================
   Spinner 狀態控制（查詢時）
   ========================= */
function setLoading(on){
  const $btn = $('#btnSearch');
  if(on){
    if(!$btn.data('orig')) $btn.data('orig', $btn.html());
    $btn.prop('disabled', true)
        .html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>讀取中…');
  }else{
    $btn.prop('disabled', false).html($btn.data('orig') || '查詢');
  }
}

/* =========================
   查詢（打 GAS）＋渲染
   ========================= */
function searchAndRender(nameInput){
  const key = (nameInput||'').trim();
  if(!key){
    $('#emptyHint').removeClass('d-none').text('請輸入姓名');
    $('#cardPerson,#cardSummary,#cardCourses,#cardAwards,#cardMonthly').addClass('d-none');
    return;
  }
  $('#emptyHint').addClass('d-none');

  CURRENT_PERSON = null;
  CURRENT_HOURS  = null;
  __PENDING__ = 2;
  setLoading(true);

  // 人員資料
  jsonp(`${GAS_WEB_APP_URL}?fn=person&name=${encodeURIComponent(key)}`, res=>{
    CURRENT_PERSON = (res && res.ok && res.row) ? res.row : false;
    doneOne();
  });
  // 該人時數整列
  jsonp(`${GAS_WEB_APP_URL}?fn=hours_row&name=${encodeURIComponent(key)}`, res=>{
    CURRENT_HOURS = (res && res.ok) ? res : { months:{}, total:0, name:key };
    doneOne();
  });
}
function doneOne(){
  __PENDING__--;
  if(__PENDING__<=0){
    setLoading(false);
    maybeRender();
  }
}
function maybeRender(){
  if(CURRENT_PERSON === false){
    $('#cardPerson,#cardSummary,#cardCourses,#cardAwards,#cardMonthly').addClass('d-none');
    $('#emptyHint').removeClass('d-none').text('查無此人，請重新輸入');
    return;
  }
  if(CURRENT_PERSON && CURRENT_HOURS) renderUI();
}

function renderUI(){
  const me = CURRENT_PERSON;
  const hr = CURRENT_HOURS;
  const {y,m} = curYM();

  /* 個人資料卡 */
  $('#p_unit').text(getField(me, ['單位']) || '—');
  $('#p_title').text(getField(me, ['職稱']) || '—');
  $('#p_name').text(getField(me, ['姓名']) || '—');
  $('#cardPerson').removeClass('d-none');

  /* 協勤：合計、本月、近 N 月 */
  const dutyTotal = Number(hr.total||0);
  $('#dutyHoursTotal').text(dutyTotal);
  const j = judgeDuty(y,m,hr);
  $('#ymRoc').text(fmtYm(y,m));
  $('#monthHours').text(j.mon);
  $('#dutyStatus').toggleClass('ok',j.ok).toggleClass('warn',!j.ok).text(j.ok?'正常':'未達標');
  $('#ruleDuty').text(`每月 ≥ ${RULES.duty.minMonthlyHours} 小時或近 ${RULES.display.recentMonths} 月合計 ≥ ${RULES.duty.rolling.minSum} 小時`);
  const lines = recentKeys(y,m,RULES.display.recentMonths).map(k=>{
    const v = Number((hr.months||{})[gyToRocYm(k)]||0);
    return `${k}：${v} 小時`;
  }).join('\n');
  $('#recentN').text(`最近 ${RULES.display.recentMonths} 月（含本月）累計：${j.sum} 小時\n\n${lines}`);

  /* 常年訓練（無則 0） */
  const thisYear = new Date().getFullYear();
  const att   = getNum(me, ['當年出席','訓練出席','出席次數']);
  const leave = getNum(me, ['當年請假','訓練請假','請假次數']);
  const abs   = getNum(me, ['當年缺席','訓練缺席','缺席次數']);
  $('#trainingYear').text(thisYear);
  $('#trainingAttend').text(att);
  $('#trainingLeave').text(leave);
  $('#trainingAbsent').text(abs);
  const trainOK = att >= RULES.training.minAttendPerYear;
  $('#trainingStatus').toggleClass('ok',trainOK).toggleClass('warn',!trainOK).text(trainOK?'正常':'未達標');
  $('#ruleTraining').text(`全年訓練應達 ${RULES.training.minAttendPerYear} 次`);

  /* 服務年資（改用：素行調查時間） */
  const serviceYears = calcServiceYearsFromConduct(me);
  $('#serviceYears').text(serviceYears);

  /* 入隊累積時數：以 hours 合計為主；人員表若有覆蓋則用人員表 */
  let acc = dutyTotal;
  const accFromPeople = getNum(me, ['入隊累積時數','累積時數','總時數']);
  if(accFromPeople>0) acc = accFromPeople;
  $('#joinAccHours').text(acc);

  /* 班程（3 列） */
  const basic  = getField(me, ['新進人員基本訓練']);
  const cadre  = getField(me, ['基礎幹部講習班']);
  const junior = getField(me, ['初級幹部講習班']);
  $('#courseBasicState') .toggleClass('ok',asBoolDone(basic)).toggleClass('warn',!asBoolDone(basic)).text(courseLabelRaw(basic||''));
  $('#courseCadreState') .toggleClass('ok',asBoolDone(cadre)).toggleClass('warn',!asBoolDone(cadre)).text(courseLabelRaw(cadre||''));
  $('#courseJuniorState').toggleClass('ok',asBoolDone(junior)).toggleClass('warn',!asBoolDone(junior)).text(courseLabelRaw(junior||''));
  $('#ruleCourseBasic').text(`基本訓練 ${RULES.courses.basic.mustFinishWithinYears} 年內完成`);
  $('#ruleCourseCadre').text(`幹部講習滿 ${RULES.cadre?.eligibleAfterYears || RULES.courses.cadre.eligibleAfterYears} 年後、${RULES.courses.cadre.mustFinishWithinYears} 年內完成`);
  $('#ruleCourseJunior').text(RULES.courses.junior.note || '');

  /* 獎項（欄位若有年份→已得獎；否則依規則推） */
  const phoenixVal = getField(me, ['鳳凰獎']);
  const emsVal     = getField(me, ['全國救護志工菁英','救護志工菁英']);
  function awardYearLabel(v){
    const s=String(v||'').trim(); if(!s) return null;
    const y = s.match(/^\d{3,4}$/) ? s : (s.match(/(19|20)?\d{2}/)?.[0] || null);
    return y || null;
  }
  const phYear = awardYearLabel(phoenixVal);
  const emYear = awardYearLabel(emsVal);
  if(phYear){ $('#awardPhoenix').removeClass('warn').addClass('ok').text(`已得獎（${phYear}）`); }
  else{
    const phOK = (serviceYears>=RULES.awards.phoenix.minServiceYears) && (acc>=RULES.awards.phoenix.minTotalHours);
    $('#awardPhoenix').toggleClass('ok',phOK).toggleClass('warn',!phOK).text(phOK?'符合資格':'未符合');
  }
  if(emYear){ $('#awardEMS').removeClass('warn').addClass('ok').text(`已得獎（${emYear}）`); }
  else{
    const emOK = (serviceYears>=RULES.awards.emsElite.minServiceYears);
    $('#awardEMS').toggleClass('ok',emOK).toggleClass('warn',!emOK).text(emOK?'符合資格':'未符合');
  }

  /* 顯示所有卡片 */
  $('#cardSummary,#cardCourses,#cardAwards,#cardMonthly').removeClass('d-none').data('name', getField(me,['姓名']));
}

/* =========================
   事件綁定 & 初始化
   ========================= */
$('#btnSearch').on('click', ()=> searchAndRender($('#txtName').val()));
$('#txtName').on('keydown', e=>{ if(e.key==='Enter') searchAndRender($('#txtName').val()); });

$(function(){
  initYM();
});
</script>
</body>
</html>
