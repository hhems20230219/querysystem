<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>人員資料清單（GitHub 前端 × Google Sheet）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 與 jQuery（CDN） -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body { background: #f7f8fa; }
    .page-title { font-weight: 800; letter-spacing: .04em; }
    .table-wrap { overflow: auto; background: #fff; border: 1px solid #e9ecef; border-radius: .5rem; }
    thead th { position: sticky; top: 0; background: #f0f3f6; z-index: 1; }
    .badge-dot { display:inline-block; width:.5rem; height:.5rem; border-radius:50%; margin-right:.35rem; background:#28a745; }
    .toolbar { gap: .5rem; }
    .muted { color:#6c757d; font-size:.9rem; }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-end mb-3">
      <div>
        <h1 class="page-title mb-0">人員資料清單</h1>
        <div class="muted" id="txtUpdated">載入中…</div>
      </div>
      <div class="d-flex toolbar">
        <input id="txtSearch" class="form-control" placeholder="關鍵字搜尋（姓名 / 職稱 / 單位 / 身分證）">
        <button id="btnReload" class="btn btn-outline-primary">重新載入</button>
      </div>
    </div>

    <div class="table-wrap">
      <table class="table table-sm table-hover align-middle mb-0" id="tblPeople">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="mt-3 muted">
      <span class="badge-dot"></span>資料來源：Google Sheet〈人員資料〉（透過 Apps Script 提供）
    </div>
  </div>

  <script>
    // === 必改：填入你的 Apps Script Web App URL（/exec 結尾） ===
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzxBQQy3upKh_Wd3CcSs6YpZro7tI57EI6AzE_Z44y5A_vEX4OoMEnSHr6XvvsXzqhC/exec'; // 例如：https://script.google.com/macros/s/AKfycb.../exec

    // === 全域狀態 ===
    let RAW_HEADERS = [];
    let RAW_ROWS = [];
    let FILTERED_ROWS = [];

    // === UI 綁定 ===
    $(function() {
      $('#btnReload').on('click', loadData);
      $('#txtSearch').on('input', function() {
        const q = $(this).val().trim();
        applyFilter(q);
      });
      // 首次載入
      loadData();
    });

    // === 讀資料（用 JSONP 保證跨網域） ===
    function loadData() {
      $('#txtUpdated').text('載入中…');
      // 先移除舊的 JSONP script
      $('script[data-jsonp]').remove();
      // 建立新的 JSONP 呼叫
      const cbName = 'renderPeople_' + Date.now();
      window[cbName] = function(payload){ renderPeople(payload); delete window[cbName]; };

      const script = document.createElement('script');
      script.src = `${GAS_WEB_APP_URL}?callback=${cbName}`;
      script.setAttribute('data-jsonp', '1');
      script.onerror = function() {
        $('#txtUpdated').text('讀取失敗，請檢查 Apps Script 是否已發佈，或 URL 是否正確。');
      };
      document.body.appendChild(script);
    }

    // === 收到資料後渲染 ===
    function renderPeople(payload) {
      if (!payload || payload.ok !== true) {
        $('#txtUpdated').text(payload && payload.error ? `讀取失敗：${payload.error}` : '讀取失敗');
        return;
      }
      RAW_HEADERS = payload.headers || [];
      RAW_ROWS = payload.rows || [];
      FILTERED_ROWS = RAW_ROWS.slice();

      $('#txtUpdated').text(`共 ${RAW_ROWS.length} 筆；更新時間：${payload.updatedAt || '—'}`);

      // 建表頭
      const ths = RAW_HEADERS.map(h => `<th class="text-nowrap">${escapeHtml(h)}</th>`).join('');
      $('#thead').html(`<tr>${ths}</tr>`);

      // 建資料列
      renderBody(FILTERED_ROWS);
    }

    function renderBody(rows) {
      const tdsHtml = rows.map(rowObj => {
        const tds = RAW_HEADERS.map(h => `<td>${escapeHtml(rowObj[h] ?? '')}</td>`).join('');
        return `<tr>${tds}</tr>`;
      }).join('');
      $('#tbody').html(tdsHtml || `<tr><td colspan="${RAW_HEADERS.length}" class="text-center text-muted">查無資料</td></tr>`);
    }

    // === 關鍵字過濾（姓名 / 職稱 / 單位 / 身分證…實際上全欄一起比對） ===
    function applyFilter(q) {
      if (!q) {
        FILTERED_ROWS = RAW_ROWS.slice();
        renderBody(FILTERED_ROWS);
        return;
      }
      const keyword = q.toLowerCase();
      FILTERED_ROWS = RAW_ROWS.filter(o => {
        return Object.values(o).some(v => String(v).toLowerCase().includes(keyword));
      });
      renderBody(FILTERED_ROWS);
    }

    // === HTML 逃脫 ===
    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }
  </script>
</body>
</html>
